//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.18408
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
using System;
using UnityEngine;

public class CombatOperationExecutor
{

	public void ExecutePhysicalAttack(BattleEntity src, BattleEntity dest, 
	                                BattleActionPhysical action,                                   	
	                                CombatStatusEffectList options,
	                                DamageType damageType,
	                                ICombatNode physicalCombatNode) {
		CombatResolver offensiveResolver = new CombatResolver (src, physicalCombatNode);
		CombatResolver defensiveResolver = new CombatResolver (dest);
		PhysicalAttackOperation attackOperation = new PhysicalAttackOperation(src, dest, action, damageType);

		ExecuteOperation (attackOperation, offensiveResolver, defensiveResolver, options);
	}

	public void ExecuteMagicalAttack(BattleEntity src, BattleEntity dest, 
	                               BattleActionMagical action, 
	                               CombatStatusEffectList options,
	                                 DamageType damageType,
	                                 ICombatNode magicalCombatNode) {
		// TODO, move src, dest to resolver type actions exposing raw battle entity
		// remove battle action from event
		// damage type ok
		CombatResolver offensiveResolver = new CombatResolver (src, magicalCombatNode);
		CombatResolver defensiveResolver = new CombatResolver (dest);
		MagicAttackOperation magicOperation = new MagicAttackOperation (src, dest, action, damageType);

		ExecuteOperation (magicOperation, offensiveResolver, defensiveResolver, options);
	}

	public void ExecutePositive(BattleEntity src, BattleEntity dest, 
	                                 BattleActionPositive action, 
	                                 CombatStatusEffectList options) {
		
	}


	/// <summary>
	/// Execute an operation and manage check resulting event with CombatStatusEffect Rules if any
	/// </summary>
	/// <param name="operation">Operation.</param>
	private void ExecuteOperation(ICombatOperation operation, CombatResolver srcResolver, CombatResolver destResolver, CombatStatusEffectList statusList) {
		IBattleEvent battleEvent = operation.Execute (srcResolver, destResolver);

		// notify resulting battle event
		BattleSystem.eventManager.NotifyEvent (battleEvent);

		// check to see if it was a damage event to see if we killed them
		if (battleEvent.eventType == BattleEventType.DAMAGE) {
			DamageEvent dmgEvent = (DamageEvent) battleEvent;

			// if character died, notify death event
			BattleEntity destEntity = dmgEvent.destEntity;
			if(destEntity.currentHP <= 0) {
				destEntity.character.curHP = 0;
				DeathEvent deathEvent = new DeathEvent(destEntity);
				BattleSystem.eventManager.NotifyEvent(deathEvent);
			}
		}

		// lets see if we hit the target or not
		bool hitTarget = battleEvent.eventType == BattleEventType.DAMAGE
						|| battleEvent.eventType == BattleEventType.NON_DAMAGE 
						|| battleEvent.eventType == BattleEventType.ITEM;

		bool missedTarget = battleEvent.eventType == BattleEventType.DODGE
						|| battleEvent.eventType == BattleEventType.RESIST;

		// iterate through combnat effects to see what should apply
		foreach (CombatStatusEffect combatStatusEffect in statusList.statusEffects) {
			switch(combatStatusEffect.rule) {			
			case CombatStatusEffect.StatusEffectRule.ON_HIT:
				if(hitTarget) {
					ApplyEffect(combatStatusEffect, srcResolver.entity);
				}
				break;
			case CombatStatusEffect.StatusEffectRule.ON_MISS:
				if(missedTarget) {
					ApplyEffect(combatStatusEffect, srcResolver.entity);
				}
				break;
			case CombatStatusEffect.StatusEffectRule.ALWAYS:
			default:
				ApplyEffect(combatStatusEffect, srcResolver.entity);
				break;
			}
		}


	}

	/// <summary>
	/// Applies the effect. Notify the StatusEffect to the event manager
	/// </summary>
	/// <param name="effects">Effects.</param>
	/// <param name="targetEntity">Target entity.</param>
	private void ApplyEffect(CombatStatusEffect combatEffect, BattleEntity srcEntity) {
		BattleEntity destEntity = combatEffect.target;
		IStatusEffect statusEffect = combatEffect.effect;
		// first directly apply the effect
		destEntity.ApplyStatusEffect (statusEffect);
		// then create an event to notify that there has been some event for this status effect
		IBattleEvent statusEvent = new StatusEffectEvent (srcEntity, destEntity, statusEffect);
		BattleSystem.eventManager.NotifyEvent(statusEvent);
	}
	
	// calculate and apply damage state (see if they are dead or not)
	private void PostDamageEvent(DamageEvent dmgEvent) {
		BattleEntity destEntity = dmgEvent.destEntity;
		// if character died, notify death event
		if(destEntity.character.curHP <= 0) {
			destEntity.character.curHP = 0;
			DeathEvent deathEvent = new DeathEvent(destEntity);
			BattleSystem.eventManager.NotifyEvent(deathEvent);
		}

	}		
}
